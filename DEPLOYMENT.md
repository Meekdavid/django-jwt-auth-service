# üöÄ Deployment Guide - Django JWT Auth Service

This guide covers deploying your Django JWT Authentication Service to Railway and Render with PostgreSQL and Redis.

## üõ†Ô∏è Pre-Deployment Checklist

‚úÖ **Production Dependencies Added**
- `gunicorn` - WSGI server for production
- `whitenoise` - Static file serving
- `drf-spectacular` - API documentation

‚úÖ **Configuration Files Created**
- `Procfile` - Process definitions for deployment
- `railway.json` - Railway-specific configuration
- `runtime.txt` - Python version specification
- Enhanced production settings

‚úÖ **Health Check Endpoint**
- `/healthz` - Monitors database and Redis connectivity

## üöÇ Railway Deployment (Recommended)

### Step 1: Prepare Your Repository
Your code is already prepared with all necessary files!

### Step 2: Deploy to Railway

1. **Go to Railway**: Visit [railway.app](https://railway.app)
2. **Sign up/Login**: Use GitHub authentication
3. **Create New Project**: Click "New Project"
4. **Deploy from GitHub**: 
   - Select "Deploy from GitHub repo"
   - Choose your repository: `Meekdavid/django-jwt-auth-service`
   - Click "Deploy"

### Step 3: Add Services

#### Add PostgreSQL Database:
1. In your Railway project dashboard
2. Click "Add Service" ‚Üí "Database" ‚Üí "PostgreSQL"
3. Railway will automatically create a PostgreSQL instance

#### Add Redis Cache:
1. Click "Add Service" ‚Üí "Database" ‚Üí "Redis"
2. Railway will automatically create a Redis instance

### Step 4: Configure Environment Variables

Go to your Django service ‚Üí Variables tab and add:

```env
# Django Configuration
DJANGO_SETTINGS_MODULE=auth_service.settings.prod
SECRET_KEY=your-super-secret-key-here-min-50-chars-long
DEBUG=False
ALLOWED_HOSTS=yourdomain.railway.app,*.railway.app

# Database (Auto-generated by Railway PostgreSQL service)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Redis (Auto-generated by Railway Redis service)
REDIS_URL=${{Redis.REDIS_URL}}

# JWT Configuration (Optional - has defaults)
JWT_ACCESS_TOKEN_LIFETIME=60
JWT_REFRESH_TOKEN_LIFETIME=10080
```

### Step 5: Deploy & Test

1. Railway will automatically deploy after you add environment variables
2. Wait for deployment to complete
3. Click on your service URL
4. Test endpoints:
   - Health check: `https://yourapp.railway.app/healthz`
   - API docs: `https://yourapp.railway.app/api/schema/swagger/`
   - Registration: `https://yourapp.railway.app/api/auth/register/`

## üé® Render Deployment (Alternative)

### Step 1: Create Web Service

1. **Go to Render**: Visit [render.com](https://render.com)
2. **Create Web Service**: Connect your GitHub repository
3. **Configure Service**:
   - Name: `django-jwt-auth-service`
   - Environment: `Python 3`
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `gunicorn auth_service.wsgi:application`

### Step 2: Add Database Services

#### PostgreSQL:
1. Create new PostgreSQL database in Render
2. Note the connection details

#### Redis:
1. Create new Redis instance in Render
2. Note the connection URL

### Step 3: Environment Variables

Add in Render's Environment Variables section:

```env
DJANGO_SETTINGS_MODULE=auth_service.settings.prod
SECRET_KEY=your-super-secret-key-here
DEBUG=False
ALLOWED_HOSTS=yourapp.onrender.com
DATABASE_URL=postgresql://user:pass@host:port/dbname
REDIS_URL=redis://user:pass@host:port
```

## üîß Post-Deployment Verification

### Test Health Check
```bash
curl https://yourapp.railway.app/healthz
```

Expected response:
```json
{
  "status": "healthy",
  "checks": {
    "database": "connected",
    "redis": "connected",
    "status": "healthy"
  },
  "service": "Django JWT Auth Service",
  "version": "1.0.0"
}
```

### Test Authentication Flow

1. **Register User**:
```bash
curl -X POST https://yourapp.railway.app/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"securepass123","password2":"securepass123","full_name":"Test User"}'
```

2. **Login**:
```bash
curl -X POST https://yourapp.railway.app/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"securepass123"}'
```

3. **Access Protected Endpoint**:
```bash
curl -X GET https://yourapp.railway.app/api/auth/protected-test/ \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## üìä Monitoring & Logs

### Railway:
- View logs in Railway dashboard ‚Üí Your service ‚Üí Logs
- Monitor health at `/healthz` endpoint
- Check metrics in Railway dashboard

### Render:
- View logs in Render dashboard ‚Üí Your service ‚Üí Logs
- Set up monitoring alerts
- Use `/healthz` for health checks

## üîí Security Considerations

‚úÖ **Environment Variables**: Never commit secrets to Git
‚úÖ **HTTPS**: Both Railway and Render provide HTTPS by default
‚úÖ **ALLOWED_HOSTS**: Properly configured for your domain
‚úÖ **DEBUG**: Set to False in production
‚úÖ **Static Files**: Handled by WhiteNoise
‚úÖ **Database Connections**: Connection pooling enabled

## üö® Troubleshooting

### Common Issues:

1. **Migration Errors**: 
   - Railway runs migrations automatically via `Procfile`
   - Check logs for database connection issues

2. **Static Files Not Loading**:
   - Ensure `whitenoise` is in `MIDDLEWARE`
   - Check `STATIC_ROOT` configuration

3. **Redis Connection Issues**:
   - Verify `REDIS_URL` environment variable
   - Check Redis service is running

4. **502/503 Errors**:
   - Check application logs
   - Verify all environment variables are set
   - Test `/healthz` endpoint

### Debug Commands:
```bash
# Check environment variables (in Railway/Render console)
env | grep DJANGO
env | grep DATABASE
env | grep REDIS

# Test database connection
python manage.py dbshell

# Collect static files (if needed)
python manage.py collectstatic --noinput
```

## üéØ Success Criteria

‚úÖ **Health Check**: `/healthz` returns 200 with all services "connected"
‚úÖ **API Documentation**: Swagger UI accessible and functional
‚úÖ **Authentication**: JWT flow works end-to-end
‚úÖ **Rate Limiting**: Throttling active on auth endpoints
‚úÖ **Password Reset**: Redis-based token system operational

Your Django JWT Authentication Service is now production-ready! üéâ
